<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>头像访问调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .debug-item {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .debug-item.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .debug-item.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .debug-item.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .url-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .avatar-preview {
            max-width: 150px;
            max-height: 150px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>头像访问调试工具</h1>
    
    <div class="debug-container">
        <h2 class="debug-title">1. 当前用户信息</h2>
        <button onclick="checkCurrentUser()">检查当前用户</button>
        <div id="userInfo"></div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">2. 头像URL测试</h2>
        <input type="text" id="avatarUrl" class="url-input" placeholder="输入头像URL或自动从用户信息获取">
        <button onclick="testAvatarUrl()">测试头像URL</button>
        <div id="avatarTest"></div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">3. 头像ID格式验证</h2>
        <input type="text" id="avatarId" class="url-input" placeholder="输入头像ID">
        <button onclick="validateAvatarId()">验证头像ID格式</button>
        <div id="idValidation"></div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">4. 头像访问调试</h2>
        <button onclick="testDatabaseQuery()">调试头像访问流程</button>
        <div id="dbTest"></div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">5. 直接API测试</h2>
        <button onclick="testGetAvatarApi()">测试get-avatar API</button>
        <div id="apiTest"></div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">调试日志</h2>
        <div id="debugLog"></div>
    </div>

    <script>
        function addLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const item = document.createElement('div');
            item.className = `debug-item ${type}`;
            item.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
        }

        function checkCurrentUser() {
            const userInfo = document.getElementById('userInfo');
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            addLog('开始检查当前用户信息');
            
            if (!token) {
                userInfo.innerHTML = '<div class="debug-item error">未找到token</div>';
                addLog('未找到token', 'error');
                return;
            }
            
            if (!currentUser) {
                userInfo.innerHTML = '<div class="debug-item error">未找到用户信息</div>';
                addLog('未找到用户信息', 'error');
                return;
            }
            
            try {
                const user = JSON.parse(currentUser);
                const info = `
                    <div class="debug-item success">
                        <strong>用户ID:</strong> ${user.id}<br>
                        <strong>用户名:</strong> ${user.username}<br>
                        <strong>头像URL:</strong> ${user.avatar || '无'}<br>
                        <strong>Token:</strong> ${token.substring(0, 20)}...
                    </div>
                `;
                userInfo.innerHTML = info;
                
                // 自动填入头像URL
                if (user.avatar) {
                    document.getElementById('avatarUrl').value = user.avatar;
                    // 提取头像ID
                    const match = user.avatar.match(/\/get-avatar\/(.+)$/);
                    if (match) {
                        document.getElementById('avatarId').value = match[1];
                        addLog(`自动提取头像ID: ${match[1]}`);
                    }
                }
                
                addLog('用户信息检查完成', 'success');
            } catch (e) {
                userInfo.innerHTML = '<div class="debug-item error">用户数据格式错误: ' + e.message + '</div>';
                addLog('用户数据解析失败: ' + e.message, 'error');
            }
        }

        function testAvatarUrl() {
            const avatarTest = document.getElementById('avatarTest');
            const avatarUrl = document.getElementById('avatarUrl').value;
            
            if (!avatarUrl) {
                avatarTest.innerHTML = '<div class="debug-item error">请输入头像URL</div>';
                addLog('未输入头像URL', 'error');
                return;
            }
            
            addLog(`开始测试头像URL: ${avatarUrl}`);
            
            // 构建完整URL
            let fullUrl = avatarUrl;
            if (avatarUrl.startsWith('/.netlify/functions/')) {
                fullUrl = 'https://blog.hanverse.pub' + avatarUrl;
            }
            fullUrl += '?t=' + Date.now();
            
            addLog(`完整URL: ${fullUrl}`);
            
            // 测试图片加载
            const img = new Image();
            img.onload = function() {
                const result = `
                    <div class="debug-item success">
                        <strong>加载成功!</strong><br>
                        <strong>URL:</strong> ${fullUrl}<br>
                        <strong>尺寸:</strong> ${this.naturalWidth}x${this.naturalHeight}<br>
                        <img src="${fullUrl}" class="avatar-preview" alt="头像预览">
                    </div>
                `;
                avatarTest.innerHTML = result;
                addLog('头像加载成功', 'success');
            };
            
            img.onerror = function() {
                const result = `
                    <div class="debug-item error">
                        <strong>加载失败!</strong><br>
                        <strong>URL:</strong> ${fullUrl}<br>
                        <strong>错误:</strong> 图片无法加载
                    </div>
                `;
                avatarTest.innerHTML = result;
                addLog('头像加载失败', 'error');
            };
            
            img.src = fullUrl;
        }

        function validateAvatarId() {
            const idValidation = document.getElementById('idValidation');
            const avatarId = document.getElementById('avatarId').value;
            
            if (!avatarId) {
                idValidation.innerHTML = '<div class="debug-item error">请输入头像ID</div>';
                addLog('未输入头像ID', 'error');
                return;
            }
            
            addLog(`验证头像ID: ${avatarId}`);
            
            // 验证格式（与get-avatar.js中的正则表达式一致）
            const isValid = /^[a-f0-9]+_[a-f0-9]+$/i.test(avatarId);
            
            const parts = avatarId.split('_');
            const userId = parts[0];
            const hash = parts[1];
            
            const result = `
                <div class="debug-item ${isValid ? 'success' : 'error'}">
                    <strong>头像ID:</strong> ${avatarId}<br>
                    <strong>格式验证:</strong> ${isValid ? '✓ 有效' : '✗ 无效'}<br>
                    <strong>用户ID部分:</strong> ${userId} (长度: ${userId ? userId.length : 0})<br>
                    <strong>哈希部分:</strong> ${hash} (长度: ${hash ? hash.length : 0})<br>
                    <strong>预期格式:</strong> [a-f0-9]+_[a-f0-9]+
                </div>
            `;
            
            idValidation.innerHTML = result;
            addLog(`头像ID验证结果: ${isValid ? '有效' : '无效'}`, isValid ? 'success' : 'error');
        }

        async function testDatabaseQuery() {
            const dbTest = document.getElementById('dbTest');
            const avatarId = document.getElementById('avatarId').value || '6887783ac676eb669a1cac72_6bf64608';
            
            addLog('开始头像访问调试测试');
            
            // 使用debug-get-avatar函数进行线上调试
            const queryUrl = `https://blog.hanverse.pub/.netlify/functions/debug-get-avatar/${encodeURIComponent(avatarId)}?debug=true`;
            addLog(`调试头像ID: ${avatarId}`);
            
            try {
                const response = await fetch(queryUrl);
                const responseData = await response.json();
                
                if (response.ok) {
                    let result = `
                        <div class="debug-item success">
                            <strong>头像访问调试成功!</strong><br>
                            <strong>时间戳:</strong> ${responseData.timestamp}<br>
                            <strong>请求路径:</strong> ${responseData.eventPath}<br>
                            <strong>提取的头像ID:</strong> ${responseData.extractedAvatarId}<br>
                            <strong>ID格式验证:</strong> ${responseData.idFormatValid ? '✓ 有效' : '✗ 无效'}<br>
                    `;
                    
                    if (responseData.databaseConnected !== undefined) {
                        result += `<strong>数据库连接:</strong> ${responseData.databaseConnected ? '✓ 成功' : '✗ 失败'}<br>`;
                    }
                    
                    if (responseData.avatarFound !== undefined) {
                        result += `<strong>头像是否存在:</strong> ${responseData.avatarFound ? '✓ 存在' : '✗ 不存在'}<br>`;
                    }
                    
                    if (responseData.avatarInfo) {
                        result += `
                            <strong>头像信息:</strong><br>
                            &nbsp;&nbsp;ID: ${responseData.avatarInfo.id}<br>
                            &nbsp;&nbsp;用户ID: ${responseData.avatarInfo.userId}<br>
                            &nbsp;&nbsp;图片类型: ${responseData.avatarInfo.imageType}<br>
                            &nbsp;&nbsp;检测到的类型: ${responseData.avatarInfo.detectedImageType}<br>
                            &nbsp;&nbsp;MIME类型: ${responseData.avatarInfo.mimeType}<br>
                            &nbsp;&nbsp;创建时间: ${responseData.avatarInfo.createdAt}<br>
                            &nbsp;&nbsp;文件大小: ${responseData.avatarInfo.size} 字节<br>
                            &nbsp;&nbsp;数据长度: ${responseData.avatarInfo.dataLength}<br>
                            &nbsp;&nbsp;Base64数据长度: ${responseData.avatarInfo.base64DataLength}<br>
                        `;
                    }
                    
                    if (responseData.idParts) {
                        result += `
                            <strong>ID格式分析:</strong><br>
                            &nbsp;&nbsp;用户ID部分: ${responseData.idParts.userIdPart} (长度: ${responseData.idParts.userIdLength})<br>
                            &nbsp;&nbsp;哈希部分: ${responseData.idParts.hashPart} (长度: ${responseData.idParts.hashLength})<br>
                        `;
                    }
                    
                    if (responseData.similarAvatars && responseData.similarAvatars.length > 0) {
                        result += `
                            <strong>相似头像:</strong><br>
                        `;
                        responseData.similarAvatars.forEach(avatar => {
                            result += `&nbsp;&nbsp;ID: ${avatar.id}, 用户: ${avatar.userId}, 创建时间: ${avatar.createdAt}<br>`;
                        });
                    }
                    
                    if (responseData.error) {
                        result += `<strong style="color: red;">错误:</strong> ${responseData.error}<br>`;
                    }
                    
                    if (responseData.databaseError) {
                        result += `<strong style="color: red;">数据库错误:</strong> ${responseData.databaseError}<br>`;
                    }
                    
                    result += '</div>';
                    dbTest.innerHTML = result;
                    addLog('头像访问调试完成', 'success');
                } else {
                    const result = `
                        <div class="debug-item error">
                            <strong>数据库查询失败!</strong><br>
                            <strong>状态码:</strong> ${response.status}<br>
                            <strong>错误信息:</strong> ${responseData.message || '未知错误'}
                        </div>
                    `;
                    dbTest.innerHTML = result;
                    addLog(`数据库查询失败: ${response.status}`, 'error');
                }
                
            } catch (error) {
                const result = `
                    <div class="debug-item error">
                        <strong>网络错误!</strong><br>
                        <strong>错误信息:</strong> ${error.message}
                    </div>
                `;
                dbTest.innerHTML = result;
                addLog(`网络错误: ${error.message}`, 'error');
            }
        }

        async function testGetAvatarApi() {
            const apiTest = document.getElementById('apiTest');
            const avatarId = document.getElementById('avatarId').value;
            
            if (!avatarId) {
                apiTest.innerHTML = '<div class="debug-item error">请先输入头像ID</div>';
                addLog('未输入头像ID', 'error');
                return;
            }
            
            addLog(`测试get-avatar API: ${avatarId}`);
            
            const apiUrl = `https://blog.hanverse.pub/.netlify/functions/get-avatar/${avatarId}`;
            
            try {
                const response = await fetch(apiUrl);
                const responseText = await response.text();
                
                let result;
                if (response.ok) {
                    result = `
                        <div class="debug-item success">
                            <strong>API调用成功!</strong><br>
                            <strong>状态码:</strong> ${response.status}<br>
                            <strong>Content-Type:</strong> ${response.headers.get('Content-Type')}<br>
                            <strong>响应大小:</strong> ${responseText.length} 字节
                        </div>
                    `;
                    addLog('API调用成功', 'success');
                } else {
                    result = `
                        <div class="debug-item error">
                            <strong>API调用失败!</strong><br>
                            <strong>状态码:</strong> ${response.status}<br>
                            <strong>错误信息:</strong><br>
                            <pre>${responseText}</pre>
                        </div>
                    `;
                    addLog(`API调用失败: ${response.status}`, 'error');
                }
                
                apiTest.innerHTML = result;
                
            } catch (error) {
                const result = `
                    <div class="debug-item error">
                        <strong>网络错误!</strong><br>
                        <strong>错误信息:</strong> ${error.message}
                    </div>
                `;
                apiTest.innerHTML = result;
                addLog(`网络错误: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查用户信息
        window.onload = function() {
            addLog('页面加载完成，开始自动检查');
            checkCurrentUser();
        };
    </script>
</body>
</html>